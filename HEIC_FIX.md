# üçé HEIC/HEIF Fix - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ iPhone —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π

## üî¥ –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π —Å iPhone (—Ñ–æ—Ä–º–∞—Ç HEIC/HEIF) –≤–æ–∑–Ω–∏–∫–∞–ª–∞ –æ—à–∏–±–∫–∞:

```
Error: heif: Invalid input: Unspecified: Bitstream not supported by this decoder (2.0)
    at POST (src/app/api/upload/route.ts:48:14)
```

**–ü—Ä–∏—á–∏–Ω–∞:** Sharp (–±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π) –Ω–µ –º–æ–∂–µ—Ç –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å HEIC/HEIF —Ñ–æ—Ä–º–∞—Ç –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –Ω–∞—Ç–∏–≤–Ω—ã—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫, –∫–æ—Ç–æ—Ä—ã–µ —Å–ª–æ–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤ serverless –æ–∫—Ä—É–∂–µ–Ω–∏–∏.

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### –ß—Ç–æ –±—ã–ª–æ –∏–∑–º–µ–Ω–µ–Ω–æ:

1. **–£–±—Ä–∞–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ Sharp** 
   - Sharp —Ç—Ä–µ–±—É–µ—Ç –Ω–∞—Ç–∏–≤–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–ª—è HEIC
   - –í—ã–∑—ã–≤–∞–ª –æ—à–∏–±–∫–∏ –Ω–∞ Vercel

2. **–ü–µ—Ä–µ–¥–∞—á–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ Cloudinary**
   - Cloudinary –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç HEIC/HEIF –∏–∑ –∫–æ—Ä–æ–±–∫–∏
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤—Å–µ—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤
   - –ë–æ–ª–µ–µ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

3. **–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ HEIC/HEIF**
   - –í —Å–ø–∏—Å–æ–∫ `allowedTypes` –¥–æ–±–∞–≤–ª–µ–Ω—ã: `image/heic`, `image/heif`
   - –¢–µ–ø–µ—Ä—å iPhone —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫

### –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã:
- ‚úÖ `/src/app/api/upload/route.ts` - —É–±—Ä–∞–Ω Sharp, –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ HEIC
- ‚úÖ `/src/app/api/upload/image/route.ts` - —É–±—Ä–∞–Ω Sharp, –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ HEIC

## üìã –ß—Ç–æ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç

### –î–û (—Å Sharp):
```typescript
// ‚ùå –û—à–∏–±–∫–∞ –Ω–∞ HEIC/HEIF
const processedImage = await sharp(buffer)
    .resize(1200, 1200)
    .jpeg({ quality: 85 })
    .toBuffer()
```

### –ü–û–°–õ–ï (—Å Cloudinary):
```typescript
// ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —Å–æ –≤—Å–µ–º–∏ —Ñ–æ—Ä–º–∞—Ç–∞–º–∏
cloudinary.uploader.upload_stream({
    transformation: [{
        width: 1200,
        height: 1200,
        crop: 'limit',
        quality: 'auto:good',
        fetch_format: 'auto', // WebP/AVIF –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
    }]
})
```

## üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞

| –ü–∞—Ä–∞–º–µ—Ç—Ä | Sharp (–¥–æ) | Cloudinary (–ø–æ—Å–ª–µ) |
|----------|------------|-------------------|
| HEIC/HEIF –ø–æ–¥–¥–µ—Ä–∂–∫–∞ | ‚ùå –ù–µ—Ç | ‚úÖ –î–∞ |
| JPEG | ‚úÖ –î–∞ | ‚úÖ –î–∞ |
| PNG | ‚úÖ –î–∞ | ‚úÖ –î–∞ |
| WebP | ‚úÖ –î–∞ | ‚úÖ –î–∞ |
| AVIF | ‚ùå –ù–µ—Ç | ‚úÖ –î–∞ |
| –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ñ–æ—Ä–º–∞—Ç | ‚ùå –ù–µ—Ç | ‚úÖ –î–∞ (WebP/AVIF) |
| –ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ | ‚ùå –ù–µ—Ç | ‚úÖ –î–∞ (auto:good) |
| CDN | ‚ùå –ù–µ—Ç | ‚úÖ –î–∞ (195 —Ç–æ—á–µ–∫) |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –õ–æ–∫–∞–ª—å–Ω–æ:
```bash
npm run dev
```

–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å:
- ‚úÖ –§–æ—Ç–æ —Å iPhone (HEIC)
- ‚úÖ JPEG
- ‚úÖ PNG
- ‚úÖ WebP

### –ù–∞ Production (Vercel):
–ü–æ—Å–ª–µ deploy –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å HEIC —Ñ–æ—Ç–æ —Å iPhone - –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ –æ—à–∏–±–æ–∫.

## üìö –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã

### `/api/upload/route.ts`:
```typescript
const allowedTypes = [
    "image/jpeg",    // JPEG, JPG
    "image/jpg",     // JPG
    "image/png",     // PNG
    "image/webp",    // WebP
    "image/heic",    // HEIC (iPhone/Mac)
    "image/heif"     // HEIF (iPhone/Mac)
]
```

### `/api/upload/image/route.ts`:
–ü—Ä–∏–Ω–∏–º–∞–µ—Ç –ª—é–±–æ–π —Ñ–æ—Ä–º–∞—Ç, –Ω–∞—á–∏–Ω–∞—é—â–∏–π—Å—è —Å `image/` (–±–æ–ª–µ–µ –ª–∏–±–µ—Ä–∞–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥)

## üîß Cloudinary Transformations

–ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è —Å–ª–µ–¥—É—é—â–∏–µ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏:

```typescript
transformation: [{
    width: 1200,           // –ú–∞–∫—Å. —à–∏—Ä–∏–Ω–∞
    height: 1200,          // –ú–∞–∫—Å. –≤—ã—Å–æ—Ç–∞
    crop: 'limit',         // –ù–µ —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å –º–∞–ª–µ–Ω—å–∫–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    quality: 'auto:good',  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ (—Ö–æ—Ä–æ—à–∏–π –±–∞–ª–∞–Ω—Å)
    fetch_format: 'auto'   // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ñ–æ—Ä–º–∞—Ç (WebP/AVIF –¥–ª—è —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤)
}]
```

## üÜò Troubleshooting

### "File must be an image"
**–ü—Ä–∏—á–∏–Ω–∞:** –ë—Ä–∞—É–∑–µ—Ä –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–∏–ª MIME-type –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è  
**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ endpoint `/api/upload/image` - –æ–Ω –±–æ–ª–µ–µ –ª–∏–±–µ—Ä–∞–ª–µ–Ω

### –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Å–µ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è
**–ü—Ä–∏—á–∏–Ω–∞:** Cloudinary credentials –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã  
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (—Å–º. `CLOUDINARY_SETUP.md`)

### –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –ø—Ä–µ–≤—ã—à–µ–Ω
**–ü—Ä–∏—á–∏–Ω–∞:** –§–∞–π–ª > 10MB  
**–†–µ—à–µ–Ω–∏–µ:** –£–º–µ–Ω—å—à–∏—Ç–µ —Ä–∞–∑–º–µ—Ä —Ñ–æ—Ç–æ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ –∏–ª–∏ —Å–æ–∂–º–∏—Ç–µ –µ–≥–æ

## üì± –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ HEIC

### –ß—Ç–æ —Ç–∞–∫–æ–µ HEIC?
- High Efficiency Image Container
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ iOS 11+ –∏ macOS High Sierra+
- –ó–∞–Ω–∏–º–∞–µ—Ç –Ω–∞ 50% –º–µ–Ω—å—à–µ –º–µ—Å—Ç–∞ —á–µ–º JPEG
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç 16-bit —Ü–≤–µ—Ç
- –õ—É—á—à–µ —á–µ–º JPEG –ø—Ä–∏ —Ç–æ–º –∂–µ —Ä–∞–∑–º–µ—Ä–µ —Ñ–∞–π–ª–∞

### –ü–æ—á–µ–º—É Sharp –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç?
Sharp –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `libvips`, –∫–æ—Ç–æ—Ä—ã–π —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Ç–∏–≤–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏:
- `libheif` –¥–ª—è HEIC/HEIF
- –ù—É–∂–Ω–∞ –∫–æ–º–ø–∏–ª—è—Ü–∏—è –ø–æ–¥ –ø–ª–∞—Ç—Ñ–æ—Ä–º—É
- –°–ª–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –≤ serverless –æ–∫—Ä—É–∂–µ–Ω–∏–∏
- –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Ä–∞–∑–º–µ—Ä deployment

### –ü–æ—á–µ–º—É Cloudinary –ª—É—á—à–µ?
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ –æ–±–ª–∞–∫–µ (–Ω–µ –ª–æ–∫–∞–ª—å–Ω–æ)
- –ù–µ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Ä–∞–∑–º–µ—Ä deployment
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ –∏–∑ –∫–æ—Ä–æ–±–∫–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
- CDN –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ fix'–∞:
- ‚úÖ HEIC/HEIF —Ñ–æ—Ç–æ —Å iPhone –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —É—Å–ø–µ—à–Ω–æ
- ‚úÖ –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ
- ‚úÖ –ë–æ–ª–µ–µ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è (Cloudinary vs Sharp)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ WebP/AVIF
- ‚úÖ –ú–µ–Ω—å—à–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –≤ –ø—Ä–æ–µ–∫—Ç–µ
- ‚úÖ –ú–µ–Ω—å—à–µ —Ä–∞–∑–º–µ—Ä deployment

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ  
**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ:** –õ–æ–∫–∞–ª—å–Ω–æ –∏ –Ω–∞ Vercel  
**–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:** iOS 11+, Android, Desktop

